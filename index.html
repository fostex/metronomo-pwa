<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metronomo Avanzato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stili personalizzati per la PWA */
        :root {
            /* Tema Scuro */
            --primary-color: #3b82f6; /* Blu di Tailwind 500 */
            --accent-color: #f97316; /* Arancione di Tailwind 500 */
            --bg-color: #1f2937; /* Grigio scuro/Nero */
            --card-color: #2d3748; /* Grigio/Blu scuro per il riquadro */
            --text-color: #f9fafb; /* Testo molto chiaro */
            --input-bg-color: #4b5563; /* Sfondo input scuro */
            --input-border-color: #6b7280;
            --tempo-text-color: #93c5fd; /* Blu chiaro/Viola come da foto */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
        }

        .metronome-card {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-color);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            padding: 30px;
            transition: all 0.3s ease-in-out;
        }
        
        /* FIX 1: Rimuove lo sfondo della card su schermi piccoli (smartphone) */
        @media (max-width: 640px) {
            .metronome-card {
                background-color: transparent; 
                box-shadow: none; 
                padding: 20px 0;
            }
        }

        /* Classe per il contenitore delle etichette e input per l'allineamento verticale */
        .input-group-aligned {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 100%;
        }

        .control-label {
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-color);
            margin-bottom: 4px; 
        }

        /* Rimuove le frecce di default dagli input di tipo number */
        input[type="number"] {
            appearance: none;
            -moz-appearance: textfield;
            background-color: var(--input-bg-color); 
            border-color: var(--input-border-color); 
            color: var(--text-color);
            height: 3.5rem; 
            border: 1px solid var(--input-border-color); 
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            text-align: center; 
        }
        
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        /* Stile per input BPM (type="text") */
        #bpm {
            background-color: transparent !important; 
            border: none !important; 
            box-shadow: none !important; 
            color: white !important; 
            font-size: 4rem !important; 
            font-weight: 900 !important; 
            height: auto !important; 
            width: 150px !important; 
            padding: 0 !important;
            margin: 0 1rem !important; 
            line-height: 1 !important;
            text-align: center !important;
        }

        /* --------------------------------- */
        /* SLIDER BPM (RIPRISTINATO) */
        /* --------------------------------- */
        input[type=range] {
          -webkit-appearance: none;
          width: 100%;
          background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
          -webkit-appearance: none;
          height: 24px;
          width: 24px;
          border-radius: 50%;
          background: var(--primary-color);
          cursor: pointer;
          margin-top: -10px;
          box-shadow: 0 0 5px rgba(0, 0, 0, 0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
          width: 100%;
          height: 4px;
          cursor: pointer;
          background: #4b5563;
          border-radius: 2px;
        }
        /* --------------------------------- */
        
        /* Stili per il pulsante BPM tondo (GRANDE) */
        .circle-stepper-btn {
            width: 60px; height: 60px; border-radius: 50%; background-color: var(--card-color); color: var(--text-color); font-size: 2.5rem; font-weight: 300; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid #4b5563; transition: background-color 0.15s, box-shadow 0.15s; line-height: 1; 
        }

        .bpm-input-stepper { display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; }
        .bpm-display-group { display: flex; align-items: center; justify-content: center; flex-direction: column; margin-bottom: 1.5rem; }
        
        /* --------------------------------- */
        /* STILI STEPPER PICCOLI (TIMER/ACCEL) */
        /* --------------------------------- */
        
        .small-circle-stepper-btn {
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            background-color: var(--card-color);
            color: var(--text-color);
            font-size: 1.5rem; 
            font-weight: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 2px solid #4b5563; 
            transition: background-color 0.15s, box-shadow 0.15s;
            line-height: 1;
            flex-shrink: 0; /* FIX 2: Impedisce la compressione orizzontale su mobile */
        }

        .small-stepper-group { display: flex; align-items: center; justify-content: center; height: 3.5rem; border: none !important; background-color: transparent !important; padding: 0; }
        
        .small-stepper-group input[type="number"] {
            background-color: transparent !important; border: none !important; box-shadow: none !important;
            color: white !important; font-size: 1.5rem !important; font-weight: 700 !important;
            height: 3.5rem !important; width: 70px !important; padding: 0 !important;
            margin: 0 0.5rem !important; line-height: 1 !important; text-align: center !important; border-radius: 0.5rem !important; 
        }
        
        /* --------------------------------- */
        /* STILI TOGGLE SWITCH (RIPRISTINATI) */
        /* --------------------------------- */
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-label {
            position: relative; 
            display: block; 
            height: 1.5rem; 
            width: 2.5rem; 
            border-radius: 9999px; 
            cursor: pointer; 
            transition: background-color 0.2s ease;
            background-color: #6b7280; /* Grigio base */
        }
        .toggle-label:before {
            content: ''; 
            position: absolute; 
            top: 2px; 
            left: 2px; 
            height: 1.25rem; 
            width: 1.25rem; 
            border-radius: 50%; 
            background: white; 
            transition: transform 0.2s ease;
        }
        .toggle-checkbox:checked + .toggle-label { 
            background-color: var(--primary-color); 
        }
        .toggle-checkbox:checked + .toggle-label:before { 
            transform: translateX(1rem); 
        }
        
        /* Stili rimanenti */
        .dynamic-tempo-text { height: 24px; font-size: 1.25rem; font-weight: 700; color: var(--tempo-text-color); margin-top: 24px; margin-bottom: 4px; }
        .tap-tempo-btn { background-color: #f97316; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); }

    </style>
</head>
<body>

    <div id="app" class="metronome-card">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-100">Metronomo</h1>
        
        <div id="timerDisplay" class="text-center text-3xl font-extrabold mb-4 text-red-400 hidden">
            00:00
        </div>
        
        <div class="bpm-display-group">
            <div class="bpm-input-stepper">
                <button type="button" id="bpmDownButton" 
                        class="circle-stepper-btn">-</button>
                <input type="text" id="bpm" value="120" min="40" max="300" pattern="[0-9]*" inputmode="numeric" data-step="1" class="new-bpm-input">
                <button type="button" id="bpmUpButton" 
                        class="circle-stepper-btn">+</button>
            </div>
            <p class="text-sm text-gray-300 mt-1" id="currentBPMText">BPM Corrente</p>
        </div>
        
        <div id="beatIndicators" class="flex justify-center space-x-4 mb-4" style="min-height: 48px;">
            </div>
        
        <div class="text-center dynamic-tempo-text">
            <span id="tempoIndicatorText" class="tracking-widest">MODERATO (109-120)</span>
        </div>


        <div class="mb-8 px-1 relative">
            <input type="range" id="bpmSlider" min="40" max="300" value="120" 
                   class="w-full transition duration-150">
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            
            <div class="input-group-aligned relative">
                <label for="timeSignatureSelect" class="control-label">Battiti per Misura</label>
                <select id="timeSignatureSelect" class="w-full appearance-none pr-8 text-center bg-gray-600 h-14 rounded-lg border border-gray-500 text-white">
                    <option value="4" selected>4/4</option>
                    <option value="2">2/4</option>
                    <option value="3">3/4</option>
                    <option value="5">5/4</option>
                    <option value="6">6/8</option>
                    <option value="7">7/4</option>
                    <option value="8">8/4</option>
                    <option value="9">9/8</option>
                    <option value="12">12/8</option>
                </select>
                <div class="absolute inset-y-0 right-0 top-[34px] flex items-center px-2 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
            
            <div class="input-group-aligned relative">
                <label for="subdivisionSelect" class="control-label">Suddivisione</label>
                <select id="subdivisionSelect" class="w-full appearance-none pr-8 text-center bg-gray-600 h-14 rounded-lg border border-gray-500 text-white">
                    <option value="2" selected>Croma (♪)</option>
                    <option value="1">Semiminima (♩)</option>
                    <option value="3">Terzina (♩³)</option>
                    <option value="4">Semicroma (♬)</option>
                </select>
                <div class="absolute inset-y-0 right-0 top-[34px] flex items-center px-2 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
            
        </div>
        
        <div class="grid grid-cols-12 gap-4 mb-6">
            <button id="startButton" class="col-span-8 w-full text-white font-bold py-5 px-4 rounded-xl 
                                             bg-green-500 hover:bg-green-600 active:bg-green-700 
                                             transition duration-150 shadow-lg shadow-green-500/50">
                INIZIA
            </button>
            <button id="tapTempoButton" class="col-span-4 w-full text-white font-bold py-5 px-4 rounded-xl 
                                                tap-tempo-btn 
                                                transition duration-150 shadow-lg">
                TAP TEMPO
            </button>
        </div>


        <div class="mb-4 flex items-center justify-between p-3 bg-gray-600 rounded-lg shadow-inner">
            <label for="timerToggle" class="text-sm font-semibold text-gray-100">Attiva Timer</label>
            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="timerToggle" id="timerToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="timerToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
            </div>
        </div>

        <div id="timerControls" class="grid grid-cols-2 gap-4 mb-6 hidden">
            <div class="input-group-aligned">
                <label for="timerMinutes" class="control-label">Minuti</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="timerMinutesDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="timerMinutes" value="1" min="0" max="99" data-step="1">
                    <button type="button" id="timerMinutesUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>
            
            <div class="input-group-aligned">
                <label for="timerSeconds" class="control-label">Secondi</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="timerSecondsDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="timerSeconds" value="0" min="0" max="59" data-step="1">
                    <button type="button" id="timerSecondsUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>
        </div>

        <div class="mb-4 flex items-center justify-between p-3 bg-gray-600 rounded-lg shadow-inner">
            <label for="progressiveAccelerationToggle" class="text-sm font-semibold text-gray-100">Accelerazione Progressiva</label>
            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="toggle" id="progressiveAccelerationToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="progressiveAccelerationToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
            </div>
        </div>

        <div id="accelerationControls" class="grid grid-cols-2 gap-4 mb-8 hidden">
            
            <div class="input-group-aligned">
                <label for="measuresForAcceleration" class="control-label">Misure per accel.</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="measuresForAccelerationDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="measuresForAcceleration" value="1" min="1" data-step="1">
                    <button type="button" id="measuresForAccelerationUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>

            <div class="input-group-aligned">
                <label for="bpmIncrease" class="control-label">Aumento BPM</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="bpmIncreaseDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="bpmIncrease" value="1" min="1" data-step="1">
                    <button type="button" id="bpmIncreaseUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>

        </div>
        
        <div id="statusMessage" class="mt-4 p-3 bg-blue-800 border border-blue-600 text-blue-100 rounded-lg text-sm hidden">
            Stato: Pronto
        </div>
    </div>

    <script>
        // Variabili globali (Omessi per brevità)
        let isRunning = false;
        let initialBPM = 120;
        let beatsPerMeasure = 4;
        let subdivisionFactor = 2;
        let totalSubBeats = 8;
        let pressTimer = null;
        let pressInterval = null;
        const INITIAL_DELAY = 400; 
        const REPEAT_INTERVAL = 100; 
        
        const tempoMap = [
            { minBPM: 40, maxBPM: 60, name: "Largo" },
            { minBPM: 61, maxBPM: 76, name: "Adagio" },
            { minBPM: 77, maxBPM: 108, name: "Andante" },
            { minBPM: 109, maxBPM: 120, name: "Moderato" },
            { minBPM: 121, maxBPM: 168, name: "Allegro" },
            { minBPM: 169, maxBPM: 200, name: "Presto" },
            { minBPM: 201, maxBPM: 300, name: "Prestissimo" }
        ];

        // ----------------------------------------------------
        // FUNZIONI GLOBALI (Logica Stepper)
        // ----------------------------------------------------
        
        function startPress(elementId, step) {
            changeValue(elementId, step);
            clearPress(); 
            pressTimer = setTimeout(() => {
                pressInterval = setInterval(() => {
                    changeValue(elementId, step);
                }, REPEAT_INTERVAL);
            }, INITIAL_DELAY);
        }

        function clearPress() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            if (pressInterval) {
                clearInterval(pressInterval);
                pressInterval = null;
            }
        }
        
        /**
         * Incrementa o decrementa il valore di un input numerico.
         * FIX 3: Garantisce il rispetto dei valori min (risolvendo il problema dei valori negativi).
         */
        function changeValue(elementId, step) {
            const input = document.getElementById(elementId);
            if (!input) return;

            // Logica BPM dedicata 
            if (elementId === 'bpm') {
                const min = parseInt(input.min) || 40;
                const max = parseInt(input.max) || 300;
                let newValue = initialBPM + step; 
                
                if (newValue < min) newValue = min;
                if (newValue > max) newValue = max;

                input.value = newValue;
                initialBPM = newValue; 
                input.dispatchEvent(new Event('input', { bubbles: true }));
                return;
            }

            // Logica per tutti gli altri campi type="number" (Timer, Accelerazione)
            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + step;

            const minAttr = input.getAttribute('min');
            const maxAttr = input.getAttribute('max');
            // FIX: usa 0 come default per min se non specificato, ma i nostri input hanno min="0" o min="1"
            const min = minAttr !== null && !isNaN(parseInt(minAttr)) ? parseInt(minAttr) : 0; 
            const max = maxAttr !== null && !isNaN(parseInt(maxAttr)) ? parseInt(maxAttr) : Infinity;

            // Logica specifica per i secondi (roll over 0-59)
            if (elementId === 'timerSeconds') {
                if (newValue < 0) newValue = 59; 
                if (newValue > 59) newValue = 0; 
            } else {
                // Logica di clamping generica (usata per Minuti e Misure per accel.)
                if (newValue < min) newValue = min; // <-- ENFORCE MIN VALUE
                if (newValue > max) newValue = max;
            }

            input.value = newValue;
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // ----------------------------------------------------
        // FUNZIONI GLOBALI (Logica UI/Configurazione)
        // ----------------------------------------------------
        
        function setupBeatIndicators() {
            const beatIndicatorsDiv = document.getElementById('beatIndicators');
            if (!beatIndicatorsDiv) return;
            beatIndicatorsDiv.innerHTML = '';
            for (let i = 0; i < beatsPerMeasure; i++) {
                const dot = document.createElement('div');
                dot.classList.add('beat-dot', 'transform', 'scale-100'); 
                dot.id = `dot-${i}`;
                beatIndicatorsDiv.appendChild(dot);
            }
        }
        
        function updateMetronomeConfig() {
            const timeSignatureSelect = document.getElementById('timeSignatureSelect'); 
            const subdivisionSelect = document.getElementById('subdivisionSelect');
            
            if (timeSignatureSelect) beatsPerMeasure = parseInt(timeSignatureSelect.value) || 4;
            if (subdivisionSelect) subdivisionFactor = parseInt(subdivisionSelect.value) || 1;
            
            totalSubBeats = beatsPerMeasure * subdivisionFactor;
            setupBeatIndicators(); 
        }
        
        function updateAccelerationControlsVisibility() {
            const progressiveAccelerationToggle = document.getElementById('progressiveAccelerationToggle');
            const accelerationControls = document.getElementById('accelerationControls');
            if (!progressiveAccelerationToggle || !accelerationControls) return;
            
            progressiveAcceleration = progressiveAccelerationToggle.checked;
            if (progressiveAcceleration) {
                accelerationControls.classList.remove('hidden');
            } else {
                accelerationControls.classList.add('hidden');
            }
        }
        
        function getTempoName(bpm) {
            let tempoEntry = tempoMap.find(entry => bpm >= entry.minBPM && bpm <= entry.maxBPM);
            if (tempoEntry) {
                const name = tempoEntry.name;
                const minBPM = tempoEntry.minBPM;
                const maxBPM = tempoEntry.maxBPM;
                const formattedName = name.charAt(0) + name.slice(1).toLowerCase();
                return `${formattedName} (${minBPM}-${maxBPM})`;
            }
            return "Tempo Sconosciuto";
        }
        
        function updateBPMDisplay(bpmValue) {
            const bpmSlider = document.getElementById('bpmSlider');
            const tempoIndicatorText = document.getElementById('tempoIndicatorText');
            const newBPM = parseInt(bpmValue);
            if (newBPM < 40 || newBPM > 300 || !bpmSlider || !tempoIndicatorText) return;
            bpmSlider.value = newBPM;
            tempoIndicatorText.textContent = getTempoName(newBPM);
        }

        // ----------------------------------------------------
        // INIZIALIZZAZIONE EVENTI (DOM Content Loaded)
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Riferimenti DOM
            const bpmInput = document.getElementById('bpm'); 
            const bpmSlider = document.getElementById('bpmSlider');
            const progressiveAccelerationToggle = document.getElementById('progressiveAccelerationToggle');
            const timerToggle = document.getElementById('timerToggle'); 
            const timerControls = document.getElementById('timerControls'); 
            const timeSignatureSelect = document.getElementById('timeSignatureSelect'); 
            const subdivisionSelect = document.getElementById('subdivisionSelect');
            
            // Inizializzazione
            updateMetronomeConfig(); 
            updateAccelerationControlsVisibility();
            initialBPM = parseInt(bpmInput.value) || 120;
            updateBPMDisplay(initialBPM);
            bpmInput.value = initialBPM; 

            // Listener per la visibilità condizionale e config
            progressiveAccelerationToggle.addEventListener('change', updateAccelerationControlsVisibility);
            timerToggle.addEventListener('change', () => {
                if (timerToggle.checked) {
                    timerControls.classList.remove('hidden');
                } else {
                    timerControls.classList.add('hidden');
                }
            });
            
            timeSignatureSelect.addEventListener('change', updateMetronomeConfig);
            subdivisionSelect.addEventListener('change', updateMetronomeConfig);

            // Gestione input BPM e Slider
            const handleBPMInput = (event) => {
                let target = event.target;
                let rawValue = target.value;
                const min = parseInt(bpmInput.min) || 40;
                const max = parseInt(bpmInput.max) || 300;
                let tempBPM;
                
                if (rawValue === '' || isNaN(parseInt(rawValue))) return; 
                tempBPM = parseInt(rawValue);

                if (tempBPM < min) { tempBPM = min; } 
                if (tempBPM > max) { tempBPM = max; }
                
                if (target.id === 'bpm') {
                    bpmSlider.value = tempBPM;
                } else if (target.id === 'bpmSlider') {
                    bpmInput.value = tempBPM;
                }
                
                updateBPMDisplay(tempBPM);
                initialBPM = tempBPM;
            };
            
            bpmInput.addEventListener('input', handleBPMInput);
            bpmSlider.addEventListener('input', handleBPMInput);


            // --- Listener per Pressione Prolungata di TUTTI gli Stepper ---
            
            const pressButtons = [
                // BPM Buttons
                { id: 'bpmDownButton', target: 'bpm', step: -1 },
                { id: 'bpmUpButton', target: 'bpm', step: 1 },
                // Timer Buttons
                { id: 'timerMinutesDown', target: 'timerMinutes', step: -1 },
                { id: 'timerMinutesUp', target: 'timerMinutes', step: 1 },
                { id: 'timerSecondsDown', target: 'timerSeconds', step: -1 },
                { id: 'timerSecondsUp', target: 'timerSeconds', step: 1 },
                // Acceleration Buttons
                { id: 'measuresForAccelerationDown', target: 'measuresForAcceleration', step: -1 },
                { id: 'measuresForAccelerationUp', target: 'measuresForAcceleration', step: 1 },
                { id: 'bpmIncreaseDown', target: 'bpmIncrease', step: -1 },
                { id: 'bpmIncreaseUp', target: 'bpmIncrease', step: 1 },
            ];
            
            const releaseEvents = ['mouseup', 'touchend', 'mouseleave', 'touchcancel'];

            pressButtons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    element.addEventListener('mousedown', (e) => {
                        if (e.button === 0) startPress(btn.target, btn.step);
                    });
                    
                    element.addEventListener('touchstart', (e) => {
                        e.preventDefault(); 
                        startPress(btn.target, btn.step);
                    }, { passive: false });

                    releaseEvents.forEach(event => {
                        element.addEventListener(event, clearPress);
                    });
                }
            });
        });

    </script>
</body>
</html>
