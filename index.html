<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metronomo Avanzato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stili personalizzati per la PWA */
        :root {
            /* Tema Scuro */
            --primary-color: #3b82f6; /* Blu di Tailwind 500 */
            --accent-color: #f97316; /* Arancione di Tailwind 500 */
            --bg-color: #1f2937; /* Grigio scuro/Nero */
            --card-color: #2d3748; /* Grigio/Blu scuro per il riquadro */
            --text-color: #f9fafb; /* Testo molto chiaro */
            --input-bg-color: #4b5563; /* Sfondo input scuro */
            --input-border-color: #6b7280;
            --tempo-text-color: #93c5fd; /* Blu chiaro/Viola come da foto */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
        }

        .metronome-card {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-color);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            padding: 30px;
            transition: all 0.3s ease-in-out;
        }
        
        /* FIX: Rimuove lo sfondo della card su schermi piccoli (smartphone) */
        @media (max-width: 640px) {
            .metronome-card {
                background-color: transparent; 
                box-shadow: none; 
                padding: 20px 0;
            }
        }

        /* Classe per il contenitore delle etichette e input per l'allineamento verticale */
        .input-group-aligned {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 100%;
        }

        .control-label {
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-color);
            margin-bottom: 4px; 
        }

        /* Rimuove le frecce di default dagli input di tipo number */
        input[type="number"] {
            appearance: none;
            -moz-appearance: textfield;
            background-color: var(--input-bg-color); 
            border-color: var(--input-border-color); 
            color: var(--text-color);
            height: 3.5rem; 
            border: 1px solid var(--input-border-color); 
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            text-align: center; 
        }
        
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        /* Stile per input BPM (type="text") */
        #bpm {
            background-color: transparent !important; 
            border: none !important; 
            box-shadow: none !important; 
            color: white !important; 
            font-size: 4rem !important; 
            font-weight: 900 !important; 
            height: auto !important; 
            width: 150px !important; 
            padding: 0 !important;
            margin: 0 1rem !important; 
            line-height: 1 !important;
            text-align: center !important;
        }

        /* --------------------------------- */
        /* SLIDER BPM */
        /* --------------------------------- */
        input[type=range] {
          -webkit-appearance: none;
          width: 100%;
          background: transparent;
        }
        /* MANOPOLA SLIDER PIÙ GRANDE */
        input[type=range]::-webkit-slider-thumb {
          -webkit-appearance: none;
          height: 32px; 
          width: 32px; 
          border-radius: 50%;
          background: var(--primary-color);
          cursor: pointer;
          margin-top: -14px; 
          box-shadow: 0 0 5px rgba(0, 0, 0, 0.4);
        }
        /* AGGIUNTO STILE MOZILLA PER COMPATIBILITÀ MANOPOLA */
        input[type=range]::-moz-range-thumb {
          height: 32px;
          width: 32px;
          border-radius: 50%;
          background: var(--primary-color);
          cursor: pointer;
          border: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
          width: 100%;
          height: 4px;
          cursor: pointer;
          background: #4b5563;
          border-radius: 2px;
        }
        
        /* Stili per il pulsante BPM tondo (GRANDE) */
        .circle-stepper-btn {
            width: 60px; height: 60px; border-radius: 50%; background-color: var(--card-color); color: var(--text-color); font-size: 2.5rem; font-weight: 300; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid #4b5563; transition: background-color 0.15s, box-shadow 0.15s; line-height: 1; 
        }

        .bpm-input-stepper { display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; }
        .bpm-display-group { display: flex; align-items: center; justify-content: center; flex-direction: column; margin-bottom: 1.5rem; }
        
        /* --------------------------------- */
        /* STILI STEPPER PICCOLI (TIMER/ACCEL) */
        /* --------------------------------- */
        
        .small-circle-stepper-btn {
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            background-color: var(--card-color);
            color: var(--text-color);
            font-size: 1.5rem; 
            font-weight: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 2px solid #4b5563; 
            transition: background-color 0.15s, box-shadow 0.15s;
            line-height: 1;
            flex-shrink: 0; 
        }
        
        .small-stepper-group { display: flex; align-items: center; justify-content: center; height: 3.5rem; border: none !important; background-color: transparent !important; padding: 0; }
        
        /* FIX: Aggiungo margine MINIMO per separare i pulsanti tondi dall'input */
        .small-stepper-group .small-circle-stepper-btn {
            margin: 0 2px; 
        }
        
        /* FIX: Riduco la larghezza dell'input e rimuovo i margini per ottimizzare lo spazio */
        .small-stepper-group input[type="number"] {
            background-color: transparent !important; border: none !important; box-shadow: none !important;
            color: white !important; font-size: 1.5rem !important; font-weight: 700 !important;
            height: 3.5rem !important; width: 60px !important; /* RIDOTTO: 60px */ padding: 0 !important;
            margin: 0 !important; /* Rimosso margine */ line-height: 1 !important; text-align: center !important; border-radius: 0.5rem !important; 
        }
        
        /* --------------------------------- */
        /* STILI TOGGLE SWITCH */
        /* --------------------------------- */
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-label {
            position: relative; display: block; height: 1.5rem; width: 2.5rem; border-radius: 9999px; cursor: pointer; transition: background-color 0.2s ease; background-color: #6b7280; 
        }
        .toggle-label:before {
            content: ''; position: absolute; top: 2px; left: 2px; height: 1.25rem; width: 1.25rem; border-radius: 50%; background: white; transition: transform 0.2s ease;
        }
        .toggle-checkbox:checked + .toggle-label { 
            background-color: var(--primary-color); 
        }
        .toggle-checkbox:checked + .toggle-label:before { 
            transform: translateX(1rem); 
        }
        
        /* --------------------------------- */
        /* STILI INDICATORI BATTITO (PALLINI) - DIMENSIONE MAGGIORATA */
        /* --------------------------------- */
        .beat-dot {
            width: 28px; 
            height: 28px; 
            border-radius: 50%;
            background-color: #4b5563; /* Grigio scuro (spento) */
            transition: background-color 0.05s ease, transform 0.05s ease;
        }

        .beat-dot.accent {
            background-color: var(--primary-color); /* Primo battito (Blu) */
            transform: scale(1.15); 
        }

        .beat-dot.strong {
            background-color: #fca5a5; /* Battiti successivi (Rosso chiaro) */
            transform: scale(1.1); 
        }
        
        /* Stili rimanenti */
        .dynamic-tempo-text { 
            height: 24px; 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--tempo-text-color); 
            margin-top: 12px; 
            margin-bottom: 4px; 
        }
        .tap-tempo-btn { background-color: #f97316; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); }

        /* Stile specifico per il messaggio di stato di errore/stop */
        .status-error {
            background-color: #991b1b; /* Rosso Scuro */
            border-color: #b91c1c; 
        }

    </style>
</head>
<body>

    <div id="app" class="metronome-card">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-100">Metronomo</h1>
        
        <div id="timerDisplay" class="text-center text-3xl font-extrabold mb-4 text-red-400 hidden">
            00:00
        </div>
        
        <div class="bpm-display-group">
            <div class="bpm-input-stepper">
                <button type="button" id="bpmDownButton" 
                        class="circle-stepper-btn">-</button>
                <input type="text" id="bpm" value="120" min="40" max="300" pattern="[0-9]*" inputmode="numeric" data-step="1" class="new-bpm-input">
                <button type="button" id="bpmUpButton" 
                        class="circle-stepper-btn">+</button>
            </div>
            <p class="text-sm text-gray-300 mt-1" id="currentBPMText">BPM Corrente</p>
        </div>
        
        <div id="beatIndicators" class="flex justify-center space-x-4 mb-4">
            </div>
        
        <div class="text-center dynamic-tempo-text">
            <span id="tempoIndicatorText" class="tracking-widest">MODERATO (109-120)</span>
        </div>


        <div class="mb-8 px-1 relative">
            <input type="range" id="bpmSlider" min="40" max="300" value="120" 
                   class="w-full transition duration-150">
        </div>

        <div class="grid grid-cols-12 gap-4 mb-6">
            <button id="startButton" class="col-span-8 w-full text-white font-bold py-5 px-4 rounded-xl 
                                             bg-green-500 hover:bg-green-600 active:bg-green-700 
                                             transition duration-150 shadow-lg shadow-green-500/50">
                INIZIA
            </button>
            <button id="tapTempoButton" class="col-span-4 w-full text-white font-bold py-5 px-4 rounded-xl 
                                                tap-tempo-btn 
                                                transition duration-150 shadow-lg">
                TAP TEMPO
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            
            <div class="input-group-aligned relative">
                <label for="timeSignatureSelect" class="control-label">Battiti per Misura</label>
                <select id="timeSignatureSelect" class="w-full appearance-none pr-8 text-center bg-gray-600 h-14 rounded-lg border border-gray-500 text-white">
                    <option value="4" selected>4/4</option>
                    <option value="2">2/4</option>
                    <option value="3">3/4</option>
                    <option value="5">5/4</option>
                    <option value="6">6/8</option>
                    <option value="7">7/4</option>
                    <option value="8">8/4</option>
                    <option value="9">9/8</option>
                    <option value="12">12/8</option>
                </select>
                <div class="absolute inset-y-0 right-0 top-[34px] flex items-center px-2 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
            
            <div class="input-group-aligned relative">
                <label for="subdivisionSelect" class="control-label">Suddivisione</label>
                <select id="subdivisionSelect" class="w-full appearance-none pr-8 text-center bg-gray-600 h-14 rounded-lg border border-gray-500 text-white">
                    <option value="2" selected>Croma (♪)</option>
                    <option value="1">Semiminima (♩)</option>
                    <option value="3">Terzina (♩³)</option>
                    <option value="4">Semicroma (♬)</option>
                </select>
                <div class="absolute inset-y-0 right-0 top-[34px] flex items-center px-2 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
            
        </div>
        
        <div class="mb-4 flex items-center justify-between p-3 bg-gray-600 rounded-lg shadow-inner">
            <label for="timerToggle" class="text-sm font-semibold text-gray-100">Attiva Timer</label>
            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="timerToggle" id="timerToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="timerToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
            </div>
        </div>

        <div id="timerControls" class="grid grid-cols-2 gap-4 mb-6 hidden">
            <div class="input-group-aligned">
                <label for="timerMinutes" class="control-label">Minuti</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="timerMinutesDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="timerMinutes" value="1" min="0" max="99" data-step="1">
                    <button type="button" id="timerMinutesUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>
            
            <div class="input-group-aligned">
                <label for="timerSeconds" class="control-label">Secondi</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="timerSecondsDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="timerSeconds" value="0" min="0" max="59" data-step="1">
                    <button type="button" id="timerSecondsUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>
        </div>

        <div class="mb-4 flex items-center justify-between p-3 bg-gray-600 rounded-lg shadow-inner">
            <label for="progressiveAccelerationToggle" class="text-sm font-semibold text-gray-100">Accelerazione Progressiva</label>
            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="toggle" id="progressiveAccelerationToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="progressiveAccelerationToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
            </div>
        </div>

        <div id="accelerationControls" class="grid grid-cols-2 gap-4 mb-8 hidden">
            
            <div class="input-group-aligned">
                <label for="measuresForAcceleration" class="control-label">Misure per accel.</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="measuresForAccelerationDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="measuresForAcceleration" value="1" min="1" data-step="1">
                    <button type="button" id="measuresForAccelerationUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>

            <div class="input-group-aligned">
                <label for="bpmIncrease" class="control-label">Aumento BPM</label>
                <div class="small-stepper-group w-full">
                    <button type="button" id="bpmIncreaseDown" 
                            class="small-circle-stepper-btn">-</button>
                    <input type="number" id="bpmIncrease" value="1" min="1" data-step="1">
                    <button type="button" id="bpmIncreaseUp" 
                            class="small-circle-stepper-btn">+</button>
                </div>
            </div>

        </div>
        
        <div id="statusMessage" class="mt-4 p-3 bg-blue-800 border border-blue-600 text-blue-100 rounded-lg text-sm hidden">
            Stato: Pronto
        </div>
    </div>

    <script>
        // ====================================================
        // VARIABILI GLOBALI E CONFIGURAZIONE METRONOMO
        // ====================================================
        let audioContext = null;
        let isRunning = false;
        let initialBPM = 120;
        let beatsPerMeasure = 4;
        let subdivisionFactor = 2;
        let totalSubBeats = 8;
        let currentSubBeat = 0;
        let timerWorker = null;
        let nextBeatTime = 0.0;
        const LOOKAHEAD = 25.0; // in ms
        const SCHEDULE_AHEAD_TIME = 0.1; // in seconds
        
        // Variabili Tap Tempo/Stepper
        let pressTimer = null;
        let pressInterval = null;
        const INITIAL_DELAY = 400; 
        const REPEAT_INTERVAL = 100; 
        
        // Variabili Tap Tempo (NEW)
        let tapTimes = [];
        const MAX_TAPS = 4; 
        
        // Variabili Timer
        let remainingTimerSeconds = 0;
        let isTimerActive = false;
        let timerCountdownInterval = null;
        
        // Variabili Accelerazione
        let isAccelerationActive = false;
        let measuresCounter = 0;
        let measuresToAccelerate = 1;
        let bpmIncreaseAmount = 1;
        
        const tempoMap = [
            { minBPM: 40, maxBPM: 60, name: "Largo" },
            { minBPM: 61, maxBPM: 76, name: "Adagio" },
            { minBPM: 77, maxBPM: 108, name: "Andante" },
            { minBPM: 109, maxBPM: 120, name: "Moderato" },
            { minBPM: 121, maxBPM: 168, name: "Allegro" },
            { minBPM: 169, maxBPM: 200, name: "Presto" },
            { minBPM: 201, maxBPM: 300, name: "Prestissimo" }
        ];

        // ====================================================
        // FUNZIONI AUDIO (GENERAZIONE SUONO E SCHEDULING)
        // ====================================================

        function playClick(time, frequency) {
            if (!audioContext) return;
            
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);

            osc.frequency.setValueAtTime(frequency, time);
            
            // Envelope per un click secco
            gainNode.gain.setValueAtTime(1, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.03); 
            
            osc.start(time);
            osc.stop(time + 0.03);
        }

        function scheduler() {
            while (nextBeatTime < audioContext.currentTime + SCHEDULE_AHEAD_TIME) {
                
                // Variabili di stato battito
                const isMainBeat = currentSubBeat % subdivisionFactor === 0;
                const isFirstBeatOfMeasure = currentSubBeat === 0;
                
                // Calcola la frequenza del suono
                let frequency = 440; // Default beat
                if (isMainBeat) {
                    const beatIndex = currentSubBeat / subdivisionFactor;
                    if (isFirstBeatOfMeasure) {
                        frequency = 880; // Primo battito (forte)
                        setTimeout(() => animateBeat(beatIndex, 'accent'), 0);
                    } else {
                        frequency = 660; // Battiti successivi (medi)
                        setTimeout(() => animateBeat(beatIndex, 'strong'), 0);
                    }
                } else {
                    frequency = 440; // Suddivisione (debole)
                }

                playClick(nextBeatTime, frequency);
                
                
                // --- Logica Accelerazione ---
                if (isAccelerationActive && isMainBeat && isFirstBeatOfMeasure) {
                    measuresCounter++;
                    
                    if (measuresCounter >= measuresToAccelerate) {
                        const maxBPM = parseInt(document.getElementById('bpm').max) || 300;
                        let newBPM = initialBPM + bpmIncreaseAmount;
                        
                        if (newBPM <= maxBPM) {
                            updateBPMDisplay(newBPM); // Aggiorna initialBPM e UI
                        } else {
                            // Raggiunto BPM massimo
                            isAccelerationActive = false;
                            document.getElementById('progressiveAccelerationToggle').checked = false;
                            const statusMessage = document.getElementById('statusMessage');
                            statusMessage.textContent = `Accelerazione fermata, raggiunto BPM massimo (${maxBPM}).`;
                            statusMessage.classList.remove('hidden', 'bg-blue-800'); 
                            statusMessage.classList.add('status-error'); // Messaggio di errore
                        }
                        measuresCounter = 0; // Reset counter
                    }
                }

                // Aggiorna il tempo del prossimo battito (usa initialBPM aggiornato)
                const secondsPerSubBeat = 60.0 / (initialBPM * subdivisionFactor); 
                nextBeatTime += secondsPerSubBeat;

                // Aggiorna il contatore del sub-battito
                currentSubBeat = (currentSubBeat + 1) % totalSubBeats;
            }
        }
        
        function animateBeat(beatIndex, type) {
            const dotElements = document.querySelectorAll('.beat-dot');
            const currentDot = dotElements[beatIndex];
            
            if (currentDot) {
                currentDot.classList.add(type);
                
                setTimeout(() => {
                    currentDot.classList.remove('accent', 'strong');
                }, 100); 
            }
        }
        
        // ====================================================
        // FUNZIONE TAP TEMPO
        // ====================================================
        function handleTapTempo() {
            const now = Date.now();
            const statusMessage = document.getElementById('statusMessage');

            if (tapTimes.length > 0 && (now - tapTimes[tapTimes.length - 1]) > 2000) {
                tapTimes = []; 
            }

            tapTimes.push(now);
            if (tapTimes.length > MAX_TAPS) {
                tapTimes.shift(); 
            }

            if (tapTimes.length >= 3) {
                let totalInterval = 0;
                for (let i = 1; i < tapTimes.length; i++) {
                    totalInterval += tapTimes[i] - tapTimes[i - 1];
                }

                const averageInterval = totalInterval / (tapTimes.length - 1);
                
                let newBPM = Math.round(60000 / averageInterval);
                
                const minBPM = 40;
                const maxBPM = 300;
                if (newBPM < minBPM) newBPM = minBPM;
                if (newBPM > maxBPM) newBPM = maxBPM;
                
                updateBPMDisplay(newBPM);
                
                statusMessage.textContent = `BPM impostato a ${newBPM}.`;
                statusMessage.classList.remove('hidden', 'status-error');
                statusMessage.classList.add('bg-blue-800');
            } else {
                statusMessage.textContent = `Tocca 3 o più volte per calcolare il BPM (Taps: ${tapTimes.length}).`;
                statusMessage.classList.remove('hidden', 'status-error');
                statusMessage.classList.add('bg-blue-800');
            }
        }


        // ====================================================
        // CONTROLLO START/STOP & LOGICA FUNZIONALITÀ
        // ====================================================

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTimerSeconds / 60);
            const seconds = remainingTimerSeconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        function updateTimerDuration() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            const totalDuration = (minutes * 60) + seconds;
            isTimerActive = document.getElementById('timerToggle').checked; 

            if (isRunning && isTimerActive) {
                if (timerCountdownInterval) {
                    clearInterval(timerCountdownInterval);
                }
                
                remainingTimerSeconds = totalDuration;
                document.getElementById('timerDisplay').classList.remove('hidden');
                updateTimerDisplay();

                timerCountdownInterval = setInterval(() => {
                    remainingTimerSeconds--;
                    updateTimerDisplay();
                    
                    if (remainingTimerSeconds <= 0) {
                        clearInterval(timerCountdownInterval);
                        startStopMetronome(); 
                    }
                }, 1000);
            } else if (!isTimerActive && isRunning) {
                 if (timerCountdownInterval) {
                    clearInterval(timerCountdownInterval);
                    timerCountdownInterval = null;
                    document.getElementById('timerDisplay').classList.add('hidden');
                }
            } else {
                remainingTimerSeconds = totalDuration;
            }
        }


        function startStopMetronome() {
            const startButton = document.getElementById('startButton');
            
            if (!isRunning) {
                // AVVIO
                if (audioContext === null) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                audioContext.resume(); 

                // 1. Configurazione Iniziale
                updateMetronomeConfig(); 
                
                // 2. Configurazione Accelerazione (Aggiorna le variabili globali all'avvio)
                updateAccelerationVars();
                measuresCounter = 0; 
                
                // 3. Configurazione Timer
                isTimerActive = document.getElementById('timerToggle').checked;
                if (isTimerActive) {
                    const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
                    const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
                    const totalTimerSeconds = (minutes * 60) + seconds;
                    
                    if (totalTimerSeconds <= 0) {
                        alert("Il timer deve essere impostato per essere attivato.");
                        document.getElementById('timerToggle').checked = false;
                        document.getElementById('timerControls').classList.add('hidden');
                        return;
                    }
                    
                    isRunning = true; 
                    updateTimerDuration();
                }

                // 4. Avvio Metronomo Core
                isRunning = true;
                currentSubBeat = 0;
                nextBeatTime = audioContext.currentTime + 0.05; 
                
                const workerContent = `
                    let timerID = null;
                    let interval = 25.0; // ms
                    self.onmessage = function(e) {
                        if (e.data == "start") {
                            timerID = setInterval(() => { postMessage("tick"); }, interval);
                        } else if (e.data == "stop") {
                            clearInterval(timerID);
                            timerID = null;
                        } else if (e.data.interval) {
                            interval = e.data.interval;
                            if (timerID) { 
                                clearInterval(timerID);
                                timerID = setInterval(() => { postMessage("tick"); }, interval);
                            }
                        }
                    };
                `;
                const workerBlob = new Blob([workerContent], { type: 'application/javascript' });
                const workerURL = URL.createObjectURL(workerBlob);
                
                timerWorker = new Worker(workerURL);
                timerWorker.onmessage = function(e) {
                    if (e.data === "tick") {
                        scheduler();
                    }
                };
                
                timerWorker.postMessage("start");
                timerWorker.postMessage({ "interval": LOOKAHEAD });
                
                startButton.textContent = 'FERMA';
                startButton.classList.replace('bg-green-500', 'bg-red-500');
                startButton.classList.replace('shadow-green-500/50', 'shadow-red-500/50');
                
            } else {
                // FERMATA
                isRunning = false;
                
                if (timerWorker) {
                    timerWorker.postMessage("stop");
                    timerWorker.terminate();
                    timerWorker = null;
                }
                
                if (timerCountdownInterval) {
                    clearInterval(timerCountdownInterval);
                    timerCountdownInterval = null;
                }
                document.getElementById('timerDisplay').classList.add('hidden');
                
                startButton.textContent = 'INIZIA';
                startButton.classList.replace('bg-red-500', 'bg-green-500');
                startButton.classList.replace('shadow-red-500/50', 'shadow-green-500/50');
                
                document.querySelectorAll('.beat-dot').forEach(dot => {
                    dot.classList.remove('accent', 'strong');
                });
                
                document.getElementById('statusMessage').classList.add('hidden');
                tapTimes = []; 
            }
        }
        
        // ====================================================
        // FUNZIONI GLOBALI (Logica UI/Configurazione)
        // ====================================================
        
        function setupBeatIndicators() {
            const beatIndicatorsDiv = document.getElementById('beatIndicators');
            if (!beatIndicatorsDiv) return;
            beatIndicatorsDiv.innerHTML = '';
            for (let i = 0; i < beatsPerMeasure; i++) {
                const dot = document.createElement('div');
                dot.classList.add('beat-dot'); 
                dot.id = `dot-${i}`;
                beatIndicatorsDiv.appendChild(dot);
            }
        }
        
        function updateMetronomeConfig() {
            const timeSignatureSelect = document.getElementById('timeSignatureSelect'); 
            const subdivisionSelect = document.getElementById('subdivisionSelect');
            
            if (timeSignatureSelect) beatsPerMeasure = parseInt(timeSignatureSelect.value) || 4;
            if (subdivisionSelect) subdivisionFactor = parseInt(subdivisionSelect.value) || 1;
            
            totalSubBeats = beatsPerMeasure * subdivisionFactor;
            
            setupBeatIndicators(); 
        }

        function updateAccelerationVars() {
            isAccelerationActive = document.getElementById('progressiveAccelerationToggle').checked;
            measuresToAccelerate = parseInt(document.getElementById('measuresForAcceleration').value) || 1;
            bpmIncreaseAmount = parseInt(document.getElementById('bpmIncrease').value) || 1;
            
            if (!isAccelerationActive) {
                measuresCounter = 0;
            }
        }

        function getTempoName(bpm) {
            let tempoEntry = tempoMap.find(entry => bpm >= entry.minBPM && bpm <= entry.maxBPM);
            if (tempoEntry) {
                const name = tempoEntry.name;
                const minBPM = tempoEntry.minBPM;
                const maxBPM = tempoEntry.maxBPM;
                const formattedName = name.charAt(0) + name.slice(1).toLowerCase();
                return `${formattedName} (${minBPM}-${maxBPM})`;
            }
            return "Tempo Sconosciuto";
        }
        
        function updateBPMDisplay(bpmValue) {
            const bpmSlider = document.getElementById('bpmSlider');
            const tempoIndicatorText = document.getElementById('tempoIndicatorText');
            const bpmInput = document.getElementById('bpm');
            const newBPM = parseInt(bpmValue);
            
            if (newBPM < 40 || newBPM > 300 || !bpmSlider || !tempoIndicatorText) return;
            
            initialBPM = newBPM; 
            
            bpmSlider.value = newBPM;
            bpmInput.value = newBPM;
            tempoIndicatorText.textContent = getTempoName(newBPM);
        }
        
        // Logica Stepper (pressione prolungata)
        function startPress(elementId, step) {
            changeValue(elementId, step);
            clearPress(); 
            pressTimer = setTimeout(() => {
                pressInterval = setInterval(() => {
                    changeValue(elementId, step);
                }, REPEAT_INTERVAL);
            }, INITIAL_DELAY);
        }

        function clearPress() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            if (pressInterval) {
                clearInterval(pressInterval);
                pressInterval = null;
            }
        }
        
        function changeValue(elementId, step) {
            const input = document.getElementById(elementId);
            if (!input) return;

            if (elementId === 'bpm') {
                const min = parseInt(input.min) || 40;
                const max = parseInt(input.max) || 300;
                let newValue = initialBPM + step; 
                
                if (newValue < min) newValue = min;
                if (newValue > max) newValue = max;

                updateBPMDisplay(newValue); 
                return;
            }

            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + step;

            const minAttr = input.getAttribute('min');
            const maxAttr = input.getAttribute('max');
            const min = minAttr !== null && !isNaN(parseInt(minAttr)) ? parseInt(minAttr) : 0; 
            const max = maxAttr !== null && !isNaN(parseInt(maxAttr)) ? parseInt(maxAttr) : Infinity;

            if (elementId === 'timerSeconds') {
                if (newValue < 0) newValue = 59; 
                if (newValue > 59) newValue = 0; 
                if (isRunning && document.getElementById('timerToggle').checked) {
                    // Update dinamico del timer
                    input.value = newValue; // Aggiorno prima il valore
                    updateTimerDuration(); 
                    return; // Esco subito
                }
            } else if (elementId === 'timerMinutes') {
                if (newValue < min) newValue = min; 
                if (newValue > max) newValue = max;
                if (isRunning && document.getElementById('timerToggle').checked) {
                    input.value = newValue;
                    updateTimerDuration();
                    return;
                }
            } else if (elementId === 'measuresForAcceleration' || elementId === 'bpmIncrease') {
                if (newValue < min) newValue = min; 
                if (newValue > max) newValue = max;
                if (isRunning && document.getElementById('progressiveAccelerationToggle').checked) {
                    input.value = newValue;
                    updateAccelerationVars(); // Update dinamico dell'accelerazione
                    return;
                }
            }
            // Se non è dinamico o non è il timer/accelerazione, aggiorna solo il valore
            input.value = newValue;
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        function updateAccelerationControlsVisibility() {
            const progressiveAccelerationToggle = document.getElementById('progressiveAccelerationToggle');
            const accelerationControls = document.getElementById('accelerationControls');
            if (!progressiveAccelerationToggle || !accelerationControls) return;
            
            if (progressiveAccelerationToggle.checked) {
                accelerationControls.classList.remove('hidden');
            } else {
                accelerationControls.classList.add('hidden');
            }

            if (isRunning) {
                updateAccelerationVars(); 
            }
        }
        
        function updateTimerControlsVisibility() {
            const timerToggle = document.getElementById('timerToggle'); 
            const timerControls = document.getElementById('timerControls'); 

            if (timerToggle.checked) {
                timerControls.classList.remove('hidden');
            } else {
                timerControls.classList.add('hidden');
            }

            if (isRunning) {
                updateTimerDuration();
            }
        }


        // ====================================================
        // INIZIALIZZAZIONE EVENTI (DOM Content Loaded)
        // ====================================================

        document.addEventListener('DOMContentLoaded', () => {
            const bpmInput = document.getElementById('bpm'); 
            const bpmSlider = document.getElementById('bpmSlider');
            const startButton = document.getElementById('startButton');
            const tapTempoButton = document.getElementById('tapTempoButton'); 
            const progressiveAccelerationToggle = document.getElementById('progressiveAccelerationToggle');
            const timerToggle = document.getElementById('timerToggle'); 
            const timeSignatureSelect = document.getElementById('timeSignatureSelect'); 
            const subdivisionSelect = document.getElementById('subdivisionSelect');
            
            const measuresForAcceleration = document.getElementById('measuresForAcceleration');
            const bpmIncrease = document.getElementById('bpmIncrease');
            const timerMinutes = document.getElementById('timerMinutes');
            const timerSeconds = document.getElementById('timerSeconds');


            // 1. Inizializzazione Configurazione UI
            updateMetronomeConfig(); 
            updateAccelerationControlsVisibility();
            updateTimerControlsVisibility();
            initialBPM = parseInt(bpmInput.value) || 120;
            updateBPMDisplay(initialBPM);
            bpmInput.value = initialBPM; 

            // 2. Listener per START/STOP e TAP TEMPO
            startButton.addEventListener('click', startStopMetronome);
            tapTempoButton.addEventListener('click', handleTapTempo); 

            // 3. Listener per la visibilità condizionale e CONFIGURAZIONE DINAMICA
            
            timerToggle.addEventListener('change', updateTimerControlsVisibility);
            progressiveAccelerationToggle.addEventListener('change', updateAccelerationControlsVisibility);

            timeSignatureSelect.addEventListener('change', updateMetronomeConfig);
            subdivisionSelect.addEventListener('change', updateMetronomeConfig);
            
            // Controlli Accelerazione (Aggiornamento dinamico)
            measuresForAcceleration.addEventListener('input', updateAccelerationVars);
            bpmIncrease.addEventListener('input', updateAccelerationVars);
            
            // Controlli Timer (Aggiornamento dinamico)
            timerMinutes.addEventListener('input', updateTimerDuration);
            timerSeconds.addEventListener('input', updateTimerDuration);


            // 4. Gestione input BPM e Slider
            const handleBPMInput = (event) => {
                let rawValue = event.target.value;
                const min = parseInt(bpmInput.min) || 40;
                const max = parseInt(bpmInput.max) || 300;
                let tempBPM;
                
                if (rawValue === '' || isNaN(parseInt(rawValue))) return; 
                tempBPM = parseInt(rawValue);

                if (tempBPM < min) { tempBPM = min; } 
                if (tempBPM > max) { tempBPM = max; }
                
                updateBPMDisplay(tempBPM); 
            };
            
            bpmInput.addEventListener('input', handleBPMInput);
            bpmSlider.addEventListener('input', handleBPMInput);


            // 5. Listener per Pressione Prolungata di TUTTI gli Stepper
            const pressButtons = [
                { id: 'bpmDownButton', target: 'bpm', step: -1 },
                { id: 'bpmUpButton', target: 'bpm', step: 1 },
                { id: 'timerMinutesDown', target: 'timerMinutes', step: -1 },
                { id: 'timerMinutesUp', target: 'timerMinutes', step: 1 },
                { id: 'timerSecondsDown', target: 'timerSeconds', step: -1 },
                { id: 'timerSecondsUp', target: 'timerSeconds', step: 1 },
                { id: 'measuresForAccelerationDown', target: 'measuresForAcceleration', step: -1 },
                { id: 'measuresForAccelerationUp', target: 'measuresForAcceleration', step: 1 },
                { id: 'bpmIncreaseDown', target: 'bpmIncrease', step: -1 },
                { id: 'bpmIncreaseUp', target: 'bpmIncrease', step: 1 },
            ];
            
            const releaseEvents = ['mouseup', 'touchend', 'mouseleave', 'touchcancel'];

            pressButtons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    element.addEventListener('mousedown', (e) => {
                        if (e.button === 0) startPress(btn.target, btn.step);
                    });
                    
                    element.addEventListener('touchstart', (e) => {
                        e.preventDefault(); 
                        startPress(btn.target, btn.step);
                    }, { passive: false });

                    releaseEvents.forEach(event => {
                        element.addEventListener(event, clearPress);
                    });
                }
            });
            
            // PWA: Registra il service worker (omesso per brevità)
        });

    </script>
</body>
</html>
